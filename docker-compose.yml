# ===========================================
# Createconomy Platform - Docker Compose
# ===========================================
# Local development setup for all applications
# Usage: docker-compose up

version: '3.8'

services:
  # Marketplace Application
  marketplace:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        APP_NAME: marketplace
    container_name: createconomy-marketplace
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/marketplace/node_modules
      - /app/apps/marketplace/.next
    environment:
      - NODE_ENV=development
      - PORT=3000
      - NEXT_PUBLIC_CONVEX_URL=${NEXT_PUBLIC_CONVEX_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
      - AUTH_SECRET=${AUTH_SECRET}
      - NEXT_PUBLIC_MARKETPLACE_URL=http://localhost:3000
      - NEXT_PUBLIC_FORUM_URL=http://localhost:3001
      - NEXT_PUBLIC_ADMIN_URL=http://localhost:3002
      - NEXT_PUBLIC_SELLER_URL=http://localhost:3003
    networks:
      - createconomy-network
    depends_on:
      - convex-dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Forum Application
  forum:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        APP_NAME: forum
    container_name: createconomy-forum
    ports:
      - "3001:3001"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/forum/node_modules
      - /app/apps/forum/.next
    environment:
      - NODE_ENV=development
      - PORT=3001
      - NEXT_PUBLIC_CONVEX_URL=${NEXT_PUBLIC_CONVEX_URL}
      - AUTH_SECRET=${AUTH_SECRET}
      - NEXT_PUBLIC_MARKETPLACE_URL=http://localhost:3000
      - NEXT_PUBLIC_FORUM_URL=http://localhost:3001
      - NEXT_PUBLIC_ADMIN_URL=http://localhost:3002
      - NEXT_PUBLIC_SELLER_URL=http://localhost:3003
    networks:
      - createconomy-network
    depends_on:
      - convex-dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Admin Application
  admin:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        APP_NAME: admin
    container_name: createconomy-admin
    ports:
      - "3002:3002"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/admin/node_modules
      - /app/apps/admin/.next
    environment:
      - NODE_ENV=development
      - PORT=3002
      - NEXT_PUBLIC_CONVEX_URL=${NEXT_PUBLIC_CONVEX_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - AUTH_SECRET=${AUTH_SECRET}
      - ADMIN_ALLOWED_EMAILS=${ADMIN_ALLOWED_EMAILS}
      - NEXT_PUBLIC_MARKETPLACE_URL=http://localhost:3000
      - NEXT_PUBLIC_FORUM_URL=http://localhost:3001
      - NEXT_PUBLIC_ADMIN_URL=http://localhost:3002
      - NEXT_PUBLIC_SELLER_URL=http://localhost:3003
    networks:
      - createconomy-network
    depends_on:
      - convex-dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Seller Application
  seller:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        APP_NAME: seller
    container_name: createconomy-seller
    ports:
      - "3003:3003"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/apps/seller/node_modules
      - /app/apps/seller/.next
    environment:
      - NODE_ENV=development
      - PORT=3003
      - NEXT_PUBLIC_CONVEX_URL=${NEXT_PUBLIC_CONVEX_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
      - STRIPE_CONNECT_CLIENT_ID=${STRIPE_CONNECT_CLIENT_ID}
      - AUTH_SECRET=${AUTH_SECRET}
      - NEXT_PUBLIC_MARKETPLACE_URL=http://localhost:3000
      - NEXT_PUBLIC_FORUM_URL=http://localhost:3001
      - NEXT_PUBLIC_ADMIN_URL=http://localhost:3002
      - NEXT_PUBLIC_SELLER_URL=http://localhost:3003
    networks:
      - createconomy-network
    depends_on:
      - convex-dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Convex Development Server (placeholder - runs locally)
  convex-dev:
    image: node:20-alpine
    container_name: createconomy-convex
    working_dir: /app/packages/convex
    volumes:
      - .:/app
      - /app/node_modules
    command: sh -c "npm install -g convex && convex dev"
    environment:
      - CONVEX_DEPLOYMENT=${CONVEX_DEPLOYMENT}
    networks:
      - createconomy-network
    profiles:
      - with-convex

  # Stripe CLI for webhook forwarding
  stripe-cli:
    image: stripe/stripe-cli:latest
    container_name: createconomy-stripe
    command: listen --forward-to marketplace:3000/api/webhooks/stripe --forward-connect-to seller:3003/api/webhooks/stripe-connect
    environment:
      - STRIPE_API_KEY=${STRIPE_SECRET_KEY}
    networks:
      - createconomy-network
    profiles:
      - with-stripe

networks:
  createconomy-network:
    driver: bridge
    name: createconomy-network

volumes:
  node_modules:
  marketplace_next:
  forum_next:
  admin_next:
  seller_next:
