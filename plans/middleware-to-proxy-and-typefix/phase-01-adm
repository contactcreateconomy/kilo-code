# Phase 01: Admin App — Middleware to Proxy Migration

## Objective

Migrate `apps/admin/src/middleware.ts` to the new Next.js 16 proxy convention.

## Current State

- **File**: [`apps/admin/src/middleware.ts`](../../apps/admin/src/middleware.ts)
- **Export**: `export function middleware(request: NextRequest)`
- **Config**: `export const config` with matcher pattern
- **Behavior**: Session-based auth guard, security headers (DENY framing, CSP, CORS), robots noindex, OPTIONS preflight handling

## Changes Required

### Step 1: Create `apps/admin/src/proxy.ts`

Create a new file `apps/admin/src/proxy.ts` with the exact same content as `middleware.ts`, but with the function renamed from `middleware` to `proxy`:

```typescript
// Before (middleware.ts)
export function middleware(request: NextRequest) {
  // ... all logic unchanged
}

// After (proxy.ts)  
export function proxy(request: NextRequest) {
  // ... all logic unchanged
}
```

The `export const config` block remains identical — no changes needed.

### Step 2: Delete `apps/admin/src/middleware.ts`

Remove the old file after the new one is verified.

### Step 3: Clean `.next` cache

Delete `apps/admin/.next/` to clear stale build artifacts that reference the old middleware path.

## Verification

- [ ] `apps/admin/src/proxy.ts` exists with `export function proxy()`
- [ ] `apps/admin/src/middleware.ts` no longer exists
- [ ] `apps/admin/.next/` is cleaned
- [ ] No other files in admin reference `middleware` as an import from the local file

## Preserved Behavior

All of the following must continue to work identically:
- Session cookie check (`createconomy_session`)
- Public routes bypass: `/auth/signin`, `/auth/unauthorized`, `/auth/callback`
- Unauthenticated users redirected to `/auth/signin?redirect=<pathname>`
- Security headers: X-Frame-Options DENY, CSP, X-Robots-Tag noindex
- CORS headers for allowed origins
- OPTIONS preflight 204 response
